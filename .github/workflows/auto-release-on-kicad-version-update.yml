name: Auto release when KiCad versions are added

on:
  push:
    branches:
      - Nick-v-L/issue52
    paths:
      - ".github/workflows/build-kicad-versions.yml"

jobs:
  detect-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Get previous version of build-kicad-versions.yml
        id: get_previous
        run: |
          # Get the previous commit's version of the file
          if ! git show HEAD~1:.github/workflows/build-kicad-versions.yml > /tmp/build-kicad-versions-prev.yml 2>/dev/null; then
            # If there's no previous commit, assume empty previous versions
            echo 'matrix:
            kicad_version: []' > /tmp/build-kicad-versions-prev.yml
          fi

      - name: Extract KiCad versions from current and previous
        id: extract_versions
        run: |
          # Extract versions from current file
          awk '
            /matrix:/ {in_matrix=1}
            in_matrix && /kicad_version:/ {
              match($0, /\[.*\]/, arr)
              gsub(/["\[\] ]/, "", arr[0])
              gsub(/,/, "\n", arr[0])
              print arr[0]
              exit
            }
          ' .github/workflows/build-kicad-versions.yml | sort > /tmp/current_versions.txt

          # Extract versions from previous file
          awk '
            /matrix:/ {in_matrix=1}
            in_matrix && /kicad_version:/ {
              match($0, /\[.*\]/, arr)
              gsub(/["\[\] ]/, "", arr[0])
              gsub(/,/, "\n", arr[0])
              print arr[0]
              exit
            }
          ' /tmp/build-kicad-versions-prev.yml | sort > /tmp/previous_versions.txt

          # Find new versions
          comm -23 /tmp/current_versions.txt /tmp/previous_versions.txt > /tmp/new_versions.txt

          echo "Current versions:"
          cat /tmp/current_versions.txt
          echo ""
          echo "Previous versions:"
          cat /tmp/previous_versions.txt
          echo ""
          echo "New versions:"
          cat /tmp/new_versions.txt

      - name: Get latest action version
        id: latest_version
        run: |
          # Get the latest version tag from the main branch
          latest_tag=$(git tag -l 'v[0-9]*.[0-9]*' --sort=-version:refname | head -n 1 | sed 's/^v//')

          if [ -z "$latest_tag" ]; then
            echo "No version tags found, using 1.0"
            latest_tag="1.0"
          fi

          echo "latest_version=$latest_tag" >> $GITHUB_OUTPUT
          echo "Latest version: $latest_tag"
